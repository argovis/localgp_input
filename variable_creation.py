import numpy, argparse, glob, pandas, gsw
from helpers import helpers

# argument setup 
parser = argparse.ArgumentParser()
parser.add_argument("--input_file", type=str, help="parquet file generated by qc_filter.py")
parser.add_argument("--variable", type=str, help="variable to compute: one of absolute_salinity, potential_temperature, or conservative_temperature")
args = parser.parse_args()

df = pandas.read_parquet(args.input_file, engine='pyarrow')

if args.variable in ['absolute_salinity', 'potential_temperature', 'conservative_temperature']:
    df['absolute_salinity'] = df.apply(
        lambda row: gsw.conversions.SA_from_SP(
            row['salinity'], row['pressure'], row['longitude'], row['latitude']
        ),
        axis=1
    )

if args.variable == 'potential_temperature':
    df['potential_temperature'] = df.apply(
        lambda row: gsw.conversions.pt0_from_t(
            row['absolute_salinity'], row['temperature'], row['pressure']
        ),
        axis=1
    )
    df['potential_temperature'] = df['potential_temperature'] + 273.15

if args.variable == 'conservative_temperature':
    df['conservative_temperature'] = df.apply(
        lambda row: gsw.conversions.CT_from_t(
            row['absolute_salinity'], row['temperature'], row['pressure']
        ),
        axis=1
    )
    df['conservative_temperature'] = df['conservative_temperature'] + 273.15

df.to_parquet(f"{args.input_file.split('.')[0]}_{args.variable}.parquet", engine='pyarrow')